<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Booking - Payment</title>
    <link rel="stylesheet" href="payment.css"> 
</head>

<body onload="loadBookingDetails()">

<header>
    <div class="logo">üè® HMS Deluxe</div>
    <nav>
        <button class="btn-home" onclick="location.href='booking.html'">Back to Booking</button>
    </nav>
</header>

<div class="container" style="max-width: 900px; margin-top: 60px;">
    
    <h1 style="color: #1a237e; text-align: center; margin-bottom: 30px;">üí≥ Secure Payment</h1>

    <div class="payment-layout">
        
        <!-- BOOKING SUMMARY -->
        <div class="booking-summary">
            <h2>Booking Details</h2>
            
            <div class="summary-item"><span>Booking ID:</span><strong id="summary-bookingId">--</strong></div>
            <div class="summary-item"><span>Room Type:</span><strong id="summary-roomType">--</strong></div>
            <div class="summary-item"><span>Room Number:</span><strong id="summary-roomNumber">--</strong></div>
            <div class="summary-item"><span>Check-in Date:</span><strong id="summary-checkin">--</strong></div>
            <div class="summary-item"><span>Check-out Date:</span><strong id="summary-checkout">--</strong></div>
            <div class="summary-item"><span>Nights:</span><strong id="summary-nights">--</strong></div>

            <h3 style="color: #1a237e; border-bottom: 1px solid #eee; padding-top: 20px;">Price Breakdown</h3>

            <div class="summary-item"><span id="summary-subTotalLabel">--</span><span id="summary-subTotal">--</span></div>
            <div class="summary-item"><span>Taxes (10%):</span><span id="summary-taxes">--</span></div>

            <div class="summary-item total-amount"><span>Total Amount:</span><span id="summary-totalAmount">--</span></div>
        </div>

        <!-- PAYMENT FORM -->
        <div class="payment-details">
            <h2>Card Information</h2>
            
            <form onsubmit="return handlePayment(event)">

                <label>Card Holder Name</label>
                <input type="text" id="card-holder" required>

                <label>Card Number</label>
                <input type="text" id="card-number" maxlength="19" required>

                <div class="input-group">
                    <div>
                        <label>Expiry Date</label>
                        <input type="text" id="expiry-date" maxlength="5" placeholder="MM/YY" required>
                    </div>
                    <div>
                        <label>CVV</label>
                        <input type="text" id="cvv" maxlength="3" required>
                    </div>
                </div>

                <label>Billing ZIP Code</label>
                <input type="text" id="billing-zip" maxlength="6" required>

                <button type="submit" class="btn-pay-now" id="payButton">Pay Now</button>
            </form>
        </div>

    </div>
</div>

<footer>&copy; 2025 HMS Deluxe. All rights reserved.</footer>

<!-- ======================= JAVASCRIPT ======================= -->

<script>
const params = new URLSearchParams(window.location.search);

// Format currency
function formatCurrency(amount) {
    return `‚Çπ${Number(amount).toLocaleString('en-IN')}`;
}

// Load booking details to display
function loadBookingDetails() {
    document.getElementById("summary-bookingId").textContent = params.get("bookingId");
    document.getElementById("summary-roomType").textContent = params.get("roomType");
    document.getElementById("summary-roomNumber").textContent = params.get("roomNumber");
    document.getElementById("summary-checkin").textContent = params.get("checkin");
    document.getElementById("summary-checkout").textContent = params.get("checkout");

    const nights = params.get("nights");
    const rate = params.get("rate");
    const subTotal = params.get("subTotal");
    const taxes = params.get("taxes");
    const total = params.get("total");

    document.getElementById("summary-nights").textContent = nights;
    document.getElementById("summary-subTotalLabel").textContent = `${nights} Nights at ${formatCurrency(rate)}/Night`;
    document.getElementById("summary-subTotal").textContent = formatCurrency(subTotal);
    document.getElementById("summary-taxes").textContent = formatCurrency(taxes);
    document.getElementById("summary-totalAmount").textContent = formatCurrency(total);

    document.getElementById("payButton").textContent = `Pay ${formatCurrency(total)} Now`;
}

// Validate expiry dates
function isExpiryValid(mm, yy) {
    const today = new Date();
    const thisMonth = today.getMonth() + 1;
    const thisYear = today.getFullYear() % 100;

    if (mm < 1 || mm > 12) return false;
    if (yy < thisYear) return false;
    if (yy === thisYear && mm < thisMonth) return false;

    return true;
}

// ======================= SAVE BOOKING TO MONGO =======================
async function saveBookingToDB() {
    const bookingData = {
        bookingId: params.get("bookingId"),
        guestUsername: params.get("guestUsername"),
        roomNumber: Number(params.get("roomNumber")),
        roomType: params.get("roomType"),
        acType: params.get("acType").toUpperCase(),
        checkin: params.get("checkin"),
        checkout: params.get("checkout"),
        nights: Number(params.get("nights")),
        rate: Number(params.get("rate")),
        total: Number(params.get("total")),
        status: "Booked"
    };

    await fetch("https://hms1-181v.onrender.com/save-booking", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bookingData)
    });
}

// ======================= MARK ROOM OCCUPIED =======================
async function occupyRoom() {
    await fetch("https://hms1-181v.onrender.com/occupy-room", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ roomNumber: Number(params.get("roomNumber")) })
    });
}

// ======================= GENERATE + UPLOAD INVOICE (CLOUDINARY) =======================
async function uploadInvoiceToCloudinary(pdfBuffer) {
    const bookingId = params.get("bookingId");

    const pdfBase64 = btoa(
        new Uint8Array(pdfBuffer)
            .reduce((data, byte) => data + String.fromCharCode(byte), "")
    );

    const response = await fetch("https://hms1-181v.onrender.com/generate-invoice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            bookingId,
            pdfBase64
        })
    });

    const result = await response.json();

    if (result.success) {
        console.log("Invoice uploaded to Cloudinary successfully!");
        // ‚ùå REMOVE: window.open(result.invoiceUrl, "_blank");
        // Do NOT redirect or open Cloudinary
    } else {
        alert("Invoice upload failed!");
    }
}

// ======================= GENERATE PDF BUFFER (EXAMPLE) =======================
async function generatePDF() {
    const text = `
        HMS Deluxe - Booking Invoice

        Booking ID: ${params.get("bookingId")}
        Room Number: ${params.get("roomNumber")}
        Check-in: ${params.get("checkin")}
        Check-out: ${params.get("checkout")}
        Nights: ${params.get("nights")}
        Total: ${params.get("total")}
    `;
    
    const encoder = new TextEncoder();
    return encoder.encode(text);
}

// ======================= MAIN PAYMENT VALIDATION =======================
async function handlePayment(event) {
    event.preventDefault();

    const cardNumber = document.getElementById("card-number").value.replace(/\s/g, "");
    const expiry = document.getElementById("expiry-date").value;
    const [mm, yy] = expiry.split("/");

    if (!/^\d{16}$/.test(cardNumber)) {
        alert("Card number must be exactly 16 digits.");
        return false;
    }

    if (!isExpiryValid(parseInt(mm), parseInt(yy))) {
        alert("Invalid expiry date.");
        return false;
    }

    const total = formatCurrency(params.get("total"));
    alert(`Successfully Paid ${total}!\nYour room is confirmed.`);

    const user = localStorage.getItem("guestUsername");
    localStorage.setItem(`lastBookedRoom_${user}`, params.get("roomNumber"));

    // ‚≠ê SAVE BOOKING + UPDATE ROOM + SAVE PAYMENT + UPLOAD INVOICE
    await saveBookingToDB();
    await occupyRoom();
    await savePaymentDetails();

    const pdfBuffer = await generatePDF();
    await uploadInvoiceToCloudinary(pdfBuffer);

    setTimeout(() => {
        window.location.href = "userhome.html";
    }, 800);

    return false;
}

// ======================= INPUT RESTRICTIONS =======================
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("card-holder").addEventListener("input", e => {
        e.target.value = e.target.value.replace(/[^A-Za-z\s]/g, "");
    });

    document.getElementById("card-number").addEventListener("input", e => {
        e.target.value = e.target.value
            .replace(/\D/g, "")
            .replace(/(.{4})/g, "$1 ")
            .trim();
    });

    document.getElementById("expiry-date").addEventListener("input", e => {
    let v = e.target.value.replace(/\D/g, "").slice(0, 4);

    if (v.length >= 3) {
        let mm = v.slice(0, 2);
        let yy = v.slice(2);

        if (parseInt(mm) > 12) {
            mm = "12";
        }

        v = mm + "/" + yy;
    }

    e.target.value = v;
    });

    document.getElementById("cvv").addEventListener("input", e => {
        e.target.value = e.target.value.replace(/\D/g, "").slice(0,3);
    });

    document.getElementById("billing-zip").addEventListener("input", e => {
        e.target.value = e.target.value.replace(/\D/g, "");
    });
});

// ======================= SAVE PAYMENT DETAILS TO MONGO =======================
async function savePaymentDetails() {
    const paymentData = {
        username: localStorage.getItem("guestUsername"),
        bookingId: params.get("bookingId"),
        totalAmount: params.get("total"),
        cardHolder: document.getElementById("card-holder").value,
        cardNumber: document.getElementById("card-number").value.replace(/\s/g, ""),
        expiryDate: document.getElementById("expiry-date").value,
        cvv: document.getElementById("cvv").value,
        billingZip: document.getElementById("billing-zip").value,
        createdAt: new Date()
    };

    await fetch("https://hms1-181v.onrender.com/save-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(paymentData)
    });
}

</script>

</body>
</html>
